syntax = "proto3"; // 指定proto版本
package node_rpc;     // 指定默认包名

// 指定golang包名
option go_package = "/node_rpc";

// 定义rpc服务
service NodeService {
  // 节点注册
  rpc Register (RegisterRequest) returns (BaseResponse) {}
  // 节点资源检测
  rpc NodeResource (NodeResourceRequest) returns (BaseResponse) {}
  // 管理下发命令到节点运行
  rpc Command (stream CmdResponse) returns (stream CmdRequest) {}
  // 节点上报创建IP的回调
  rpc StatusCreateIP(StatusCreateIPRequest)returns (BaseResponse) {}
  // 节点上报端口转发的回调
  rpc StatusBindPort(StatusBindPortRequest)returns (BaseResponse) {}
  // 节点上报删除IP的回调
  rpc StatusDeleteIP(StatusDeleteIPRequest)returns (BaseResponse) {}
  // 端口转发通道
  rpc Tunnel(stream TunnelData) returns (stream TunnelData) {};
}
// 基础响应结构体
message BaseResponse{
  int32 code = 1; // 状态码
  string msg = 2; // 响应信息
}
// 注册节点请求结构体
message RegisterRequest {
  string ip = 1; // 节点ip
  string mac = 2; // 节点mac
  string node_uid = 3; // 节点uid
  string version = 4; // 节点版本
  string Commit = 5; // 节点commit
  systemInfoMessage systemInfo = 6; // 系统信息
  resourceMessage resourceInfo = 7; // 节点资源信息
  repeated networkInfoMessage networkList = 8; // 网卡信息
}
// 节点资源检测请求结构体
message NodeResourceRequest {
  string node_uid = 1; // 节点uid
  resourceMessage resourceInfo = 2; // 节点资源信息
}
// 系统信息
message systemInfoMessage {
  string  hostName = 1; // 主机名
  string distributionVersion = 2; // 发行版本
  string coreVersion = 3; // 内核版本
  string systemType = 4; // 系统类型
  string startTime = 5; //  启动时间
}
// 节点资源信息
message resourceMessage {
  int64 cpuCount = 1; // cpu数量
  float cpuUseRate = 2; // cpu使用率
  int64 memTotal = 3; // 内存容量
  float  memUseRate = 4; // 内存使用率
  int64 diskTotal = 5; // 磁盘容量
  float  diskUseRate = 6; // 磁盘使用率
  string nodePath = 7; // 节点路径
  int64  nodeResourceOccupancy = 8; // 节点资源占用
}
// 网卡信息
message networkInfoMessage {
  string network = 1; // 网卡名称
  string ip = 2; // 网卡ip
  string net = 3; // 网卡所属子网
  int32 mask = 4; // 网卡掩码
}
// 命令类型枚举
enum CmdType {
  cmdNetworkFlushType = 0; // 网卡刷新
  cmdNetScanType = 1; // 扫描网卡
  cmdNodeRemoveType = 2; // 删除节点
}
// 命令请求结构体
message CmdRequest {
  CmdType cmdType = 1; // 命令类型
  string taskID = 2; // 任务id
  string logID = 3; // 日志id
  NetworkFlushInMessage NetworkFlushInMessage = 4; // 网卡刷新信息
  NetScanInMessage NetScanInMessage = 5; // 扫描网卡信息
  NodeRemoveInMessage NodeRemoveInMessage = 6; // 删除节点信息
}
// 网卡刷新请求结构体
message NetworkFlushInMessage {
  repeated string filterNetworkName = 1; // 过滤网卡名称
}
// 扫描网卡请求结构体
message NetScanInMessage {
  string network = 1; // 网卡名称
  string ipRange = 2; // 扫描IP范围
  repeated string filterIPList = 3; // IP过滤列表
  uint32 netID = 4; // 网络ID
}
// 删除节点请求结构体
message NodeRemoveInMessage {

}
// 网卡刷新响应结构体
message NetworkFlushOutMessage {
  repeated networkInfoMessage networkList = 1; // 网卡信息
}
// 扫描网卡响应结构体
message NetScanOutMessage {
  bool end = 1; // 是否结束
  float progress = 2; // 扫描进度
  string ip = 3; // ip
  string mac = 4; // mac地址
  string manuf = 5; // mac对应厂商
  uint32 netID = 6; // 网络id
  string errMsg = 7; // 错误信息
}
// 删除节点响应结构体
message NodeRemoveOutMessage {

}
// 命令响应结构体
message CmdResponse {
  CmdType cmdType = 1; // 命令类型
  string taskID = 2; // 任务id
  string nodeID = 3; // 节点id
  int32 code = 4; // 状态码
  string errorMsg = 5; // 错误信息
  string logID = 6; // 日志id

  NetworkFlushOutMessage NetworkFlushOutMessage = 7; // 网卡刷新信息
  NetScanOutMessage NetScanOutMessage = 8; // 扫描网卡信息
  NodeRemoveOutMessage NodeRemoveOutMessage = 9; // 删除节点信息
}
// 创建IP状态回调结构体
message StatusCreateIPRequest {
  uint32 honeyIPID = 1; // 诱捕ipID
  string errMsg = 2; // 错误信息
  string network = 3; // 网卡名称
  string mac = 4; // mac地址
  string logID = 5; // 日志id
}
// 端口转发状态回调结构体
message StatusBindPortRequest {
  uint32 honeyIPID = 1; // 诱捕ipID
  repeated statusPortInfo portInfoList  = 2; // 端口信息列表
  string logID = 3; // 日志id
}
// 端口信息结构体
message statusPortInfo {
  int64 port = 1; // 端口号
  string msg = 2; // 相关信息
}
// 删除IP状态回调结构体
message StatusDeleteIPRequest {
  repeated uint32 honeyIPIDList = 1; // 诱捕ipID列表
  int64 netID = 2; // 网络id
  string logID = 3; // 日志id
}
// 传输的数据块
message TunnelData {
  bytes chunk = 1;  // 数据块
  string address = 2; // 目标地址
}
// protoc --go_out=. --go-grpc_out=. *.proto
// 在rpc目录下执行